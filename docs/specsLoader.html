<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Specification Loader - Spock GOS</title>
    <link rel="stylesheet" href="reference/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .spec-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .spec-nav {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .spec-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .spec-content h1 { margin-top: 0; color: #1976d2; }
        .spec-content h2 { color: #333; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .spec-content h3 { color: #555; }
        .spec-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .spec-content th, .spec-content td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        .spec-content th {
            background: #f5f5f5;
            font-weight: bold;
        }
        .spec-content tr:nth-child(even) {
            background: #fafafa;
        }
        .spec-content pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .spec-content code {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #f0f0f0;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .spec-content pre code {
            background: none;
            padding: 0;
        }
        .spec-content ul, .spec-content ol {
            margin: 10px 0;
            padding-left: 25px;
        }
        .spec-content li {
            margin: 5px 0;
        }
        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .back-link {
            margin-bottom: 20px;
        }
        .spec-id {
            background: #e3f2fd;
            padding: 2px 8px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="nav-header">
            <h1>Spock GOS – Specification</h1>
            <small>
                <a href="index.html">Home</a> ·
                <a href="architecture/index.html">Architecture</a> ·
                <a href="syntax/index.html">Syntax</a> ·
                <a href="api/index.html">APIs</a> ·
                <a href="wiki/index.html">Wiki</a> ·
                <a href="specs/matrix.html">Specs</a>
            </small>
        </div>

        <div class="spec-container">
            <div class="back-link">
                <a href="specs/matrix.html">← Back to Specification Matrix</a>
            </div>

            <div id="content" class="spec-content">
                <div class="loading">Loading specification...</div>
            </div>
        </div>
    </div>

    <script>
        class SpecsLoader {
            constructor() {
                this.content = document.getElementById('content');
                this.specPath = this.getSpecPath();
                this.load();
            }

            getSpecPath() {
                const params = new URLSearchParams(window.location.search);
                return params.get('spec');
            }

            async load() {
                if (!this.specPath) {
                    window.location.href = 'specs/matrix.html';
                    return;
                }

                try {
                    const response = await fetch(`specs/${this.specPath}`);
                    if (!response.ok) {
                        throw new Error(`Specification not found: ${this.specPath}`);
                    }

                    const markdown = await response.text();

                    // Use marked.js for proper markdown rendering
                    marked.setOptions({
                        gfm: true,
                        breaks: false,
                        headerIds: true
                    });

                    const html = marked.parse(markdown);
                    this.content.innerHTML = html;

                    // Extract title from the content
                    const titleMatch = markdown.match(/^#\s+(.+)$/m);
                    if (titleMatch) {
                        document.title = `${titleMatch[1]} - Spock GOS`;
                    }

                    // Highlight specification IDs
                    this.content.innerHTML = this.content.innerHTML.replace(
                        /\*\*ID:\*\* ([A-Z0-9\-\/_\.]+)/g,
                        '<strong>ID:</strong> <span class="spec-id">$1</span>'
                    );

                    // Fix internal links to use specsLoader
                    this.fixInternalLinks();

                } catch (error) {
                    this.showError(error.message);
                }
            }

            fixInternalLinks() {
                const links = this.content.querySelectorAll('a[href]');
                links.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href.endsWith('.md') && !href.startsWith('http')) {
                        // Convert relative .md links to specsLoader links
                        let newHref = href;
                        if (href.startsWith('../')) {
                            // Handle relative paths
                            newHref = href.replace(/^\.\.\//, '');
                        }
                        link.setAttribute('href', `specsLoader.html?spec=${newHref}`);
                    }
                });
            }

            showError(message) {
                this.content.innerHTML = `
                    <div class="error">
                        <h3>Error Loading Specification</h3>
                        <p>${message}</p>
                        <p><a href="specs/matrix.html">Return to Specification Matrix</a></p>
                    </div>
                `;
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new SpecsLoader();
        });
    </script>
</body>
</html>
